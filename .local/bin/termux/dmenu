#!/bin/sh

# dmenu wrapper for fzf.

if [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]; then
	for o in $@ ; do case "$o" in
		-b) layout="default" ; shift ;;
		-i) case="-i" ; shift ;;
		-l) height="$2" ; shift 2 ;;
		-p) prompt="$2" ; shift 2 ;;
		-f) shift ;;
		-nb) color_nb="$2" ; shift 2 ;;
		-nf) color_nf="$2" ; shift 2 ;;
		-sb) color_sb="$2" ; shift 2 ;;
		-sf) color_sf="$2" ; shift 2 ;;
		-[mw]) shift 2 ;;
		-*) shift ;;
	esac done

	[ -t 0 ] || items="$(xargs -0)"
	height="${height:-$(echo -n "$items" | wc -l)}"
	case 1 in
		$((height > $(tput lines))) ) height="100%" ;;
		$((height < 1)) ) height="100%" ; tmux_height="40%" ;;
		* ) height="$((height + 2))" ;;
	esac

	# dmenu format
	export FZF_DEFAULT_OPTS="--no-info --no-separator --no-scrollbar \
		--prompt='$prompt' --gutter=' ' --pointer='' --ellipsis='' \
		--highlight-line --no-hscroll --raw --border=none \
		--layout=${layout:-reverse} --height=$height \
		--tmux=top,100%,${tmux_height:-$height} ${case:-+i} \
		--preview-window='' --bind=change:best"

	# dmenu keybinds
	export FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS \
		--bind=tab:yank,ctrl-i:yank \
		--bind=ctrl-y:yank,ctrl-Y:yank \
		--bind=enter:accept \
		--bind=ctrl-j:accept,ctrl-J:accept \
		--bind=ctrl-m:accept,ctrl-M:accept \
		--bind=esc:abort,ctrl-c:abort,ctrl-g:abort \
		--bind=ctrl-left:backward-word,alt-b:backward-word \
		--bind=ctrl-right:forward-word,alt-f:forward-word \
		--bind=ctrl-a:first,alt-g:first \
		--bind=ctrl-b:up,ctrl-p:up,alt-h:up \
		--bind=ctrl-d:delete-char \
		--bind=ctrl-e:last,alt-G:last \
		--bind=ctrl-f:down,ctrl-n:down,alt-l:down \
		--bind=ctrl-h:backward-delete-char \
		--bind=ctrl-k:kill-word \
		--bind=ctrl-u:kill-line \
		--bind=ctrl-w:backward-kill-word \
		--bind=alt-j:page-down \
		--bind=alt-k:page-up"

	# wal colors
	wal_dmenu="${XDG_CACHE_DIR:-$HOME/.cache}/wal/colors-wal-dmenu.h"
	if command -v wal >/dev/null 2>&1 && [ -f "$wal_dmenu" ]; then
		color_nb="${color_nb:-$(grep "SchemeNorm" "$wal_dmenu" | cut -d'"' -f4)}"
		color_nf="${color_nf:-$(grep "SchemeNorm" "$wal_dmenu" | cut -d'"' -f2)}"
		color_sb="${color_sb:-$(grep "SchemeSel" "$wal_dmenu" | cut -d'"' -f4)}"
		color_sf="${color_sf:-$(grep "SchemeSel" "$wal_dmenu" | cut -d'"' -f2)}"
		color_ob="$(grep "SchemeOut" "$wal_dmenu" | cut -d'"' -f4)"
		color_of="$(grep "SchemeOut" "$wal_dmenu" | cut -d'"' -f2)"
	fi

	# dmenu colors
	export FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS \
		--color=list-fg:${color_nf:-#bbbbbb},hl:${color_nf:-#bbbbbb} \
		--color=prompt:${color_nf:-#bbbbbb}:regular \
		--color=nomatch:regular \
		--color=list-bg:${color_nb:-#222222} \
		--color=fg+:${color_sf:-#eeeeee},hl+:${color_sf:-#eeeeee} \
		--color=query:${color_nf:-#bbbbbb} \
		--color=bg+:${color_sb:-#005577} \
		--color=marker:${color_ob:-#00ffff}"

	if [ "${0##*/}" = "dmenu_run" ]; then
		cachedir="${XDG_CACHE_HOME:-$HOME/.cache}"
		cache="$cachedir/dmenu_run"
		[ ! -d "$cachedir" ] && mkdir -p "$cachedir"
		echo -n "$PATH" | xargs -d":" -I {} find {} -maxdepth 1 -executable -type f -printf "%P\n" | tee "$cache" >/dev/null 2>&1
		cat "$cache" | sort -u | fzf | xargs setsid -f >/dev/null 2>&1
	else
		echo "$items" | fzf
	fi

else
	"$PREFIX"/bin/dmenu "$@"
fi
